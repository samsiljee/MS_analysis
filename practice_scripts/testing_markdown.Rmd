---
title: "Testing markdown for shiny app"
author: "Sam Siljee"
date: '2023-05-16'
output: html_document
---

Created: 2023/05/16
Last modified: 2023/05/16 
Written by: Sam Siljee
copyright (c) - 2023 Sam Siljee

This document is not intended to be used to perform analyses, this is where I test certain parts of the code outside of shiny for troubleshooting.
Please see my "MSstats_workflow" repository for an older version of this script, with proper useful commenting.

# Loading packages
```{r setup, include=FALSE}
library(MSstats)
library(MSstatsTMT)
library(tidyverse)
library(EnhancedVolcano)
library(ComplexHeatmap)
library(clusterProfiler)
library(org.Hs.eg.db)
library(STRINGdb)
```

# Directories
```{r directories, include = TRUE}
# paths depending on which computer I'm running on
if(getwd() == "C:/Users/Sam/Documents/Coding/MS_analysis"){
  input_dir <- "~/Documents/Coding/MS_analysis/input/"
  output_dir <- "~/Documents/Coding/MS_analysis/output/"
}else{
  input_dir <- "~/Coding/MS_analysis/input/"
  output_dir <- "~/Coding/MS_analysis/output/"
}

# Specify the names of your raw data and annotations csv
raw_file <- "0vs20_PSMs.txt"
annotations_file <- "0vs20_annotations.csv"
```

# TMT annotations combining
```{r combine annotation files}
run_annot <- vroom("C:/Users/Sam/Documents/Coding/MS_analysis/input/TMT/Rat_TMT_run_annotations.tsv")
channel_annot <- vroom("C:/Users/Sam/Documents/Coding/MS_analysis/input/TMT/Rat_TMT_channel_annotations.tsv")
annot <- full_join(run_annot, channel_annot)

```

# Test TMT comparison
```{r TMT comparison}
TMT_input <- PDtoMSstatsTMTFormat(annotation = annotation.pd, input = raw.pd)

TMT_processed <-proteinSummarization(input.pd)

TMT_compared <- groupComparisonTMT(TMT_processed)
```


# Data import
```{r data import}
raw <- read.csv(paste0(input_dir, raw_file),
                sep = "\t",
                stringsAsFactors = FALSE) %>%
  mutate(ProteinGroupAccessions = .$Master.Protein.Accessions,
         PrecursorArea = .$Precursor.Abundance,
         Run = .$Spectrum.File)

annot_col <- read.csv(paste0(input_dir, annotations_file),
                      sep = ",",
                      stringsAsFactors = TRUE)

input <- PDtoMSstatsFormat(raw, 
                           annotation = annot_col,
                           removeProtein_with1Peptide = TRUE,
                           removeFewMeasurements = TRUE,
                           use_log_file = FALSE,
                           verbose = FALSE)
```

# Data Processing
```{r data processing, echo = FALSE}
# Testing spike-in protein normalisation
fasta <- readLines("input/porcine_trypsin.fasta")

standards <- str_extract(fasta[grep(">", fasta)],"(?<=sp\\|)[[:alnum:]]+")

processed <- dataProcess(input,
                         normalization = "globalStandards",
                         nameStandards = standards,
                         summaryMethod = "TMP",
                         censoredInt = "NA",
                         MBimpute = FALSE,
                         maxQuantileforCensored = 0.999,
                         use_log_file = FALSE,
                         verbose = FALSE)
```

# Comparison
```{r model based comparison, echo = FALSE}
comparison <- matrix(ncol = (length(levels(annot_col$Condition))), nrow = 1)
colnames(comparison) <- levels(annot_col$Condition)
rownames(comparison) <- c("20mM vs control")

comparison[1,] <- c(-1, 1)

test.MSstats <- groupComparison(contrast.matrix = comparison,
                                data = processed,
                                use_log_file = FALSE,
                                verbose = FALSE)

MSstats.results <- test.MSstats$ComparisonResult

# Add column for up/downregulated or non-significant
MSstats.results$Dif <- ifelse(MSstats.results$log2FC > 1 & MSstats.results$adj.pvalue < 0.05,
                                 "Upregulated",
                                 ifelse(MSstats.results$log2FC < -1 & MSstats.results$adj.pvalue < 0.05,
                                        "Downregulated",
                                        "Not significant"))
```

# STRING analysis
```{r STRING, echo = FALSE}
# Initialise STRING
string_db <- STRINGdb$new(version="11.5",
                          species=9606, 
                          score_threshold=700,
                          network_type="full",
                          input_directory="")

# Map whole dataset and use to set background
string_background <- string_db$map(as.data.frame(input), "ProteinName", removeUnmappedRows = TRUE) %>%
  .$STRING_id %>%
  unique()
string_db$set_background(string_background)

# New database using background
string_db <- STRINGdb$new(version="11.5",
                          species=9606, 
                          score_threshold=700,
                          network_type="full",
                          input_directory="",
                          backgroundV = string_background)

# Run STRING analysis
STRING_dataset <- MSstats.results %>%
    filter(Label == "20mM vs control") %>%
    dplyr::select(Protein, pvalue, log2FC) %>%
    arrange(pvalue) %>%
    string_db$map(
      "Protein",
      removeUnmappedRows = TRUE)
  
STRING_network_plot <- string_db$plot_network(STRING_dataset$STRING_id[1:50])

# Run enrichment
STRING_enrichment <- string_db$get_enrichment(STRING_dataset$STRING_id)

head(STRING_enrichment)
STRING_enrichment$category %>% unique


```

# GO analysis
```{r GO analysis, echo = FALSE}
go_proteins <- MSstats.results %>%
    filter(Label == "HEK vs SeasonB" & !Dif == "Not significant") %>%
    .$Protein %>%
    as.character() %>%
    unique()

go_results <- enrichGO(gene = go_proteins,
           OrgDb = org.Hs.eg.db,
           keyType = "UNIPROT",
           pAdjustMethod = "BH",
           universe = unique(input$ProteinName),
           ont = "MF",
           pvalueCutoff = 1,
           qvalueCutoff = 1)

go_results_dat <- as.data.frame(go_results) %>%
  mutate(Comparison = "comparisons", Direction = "directions", Subontology = "ont")

go_enrichment_plot_dataset <- go_results_dat %>%
  filter(Comparison == "comparisons" & Direction == "directions" & Subontology == "ont") %>%
  mutate(GeneRatio =eval(parse(text = GeneRatio))) %>%
  arrange(GeneRatio) %>%
  .[1:7,]

go_enrichment_plot <- go_enrichment_plot_dataset %>%
  ggplot(aes(x = GeneRatio, y = 1:7, col = p.adjust, size = Count)) +
  geom_point() +
  scale_y_continuous(breaks = 1:7, labels = go_enrichment_plot_dataset$Description)

go_enrichment_plot
```

# QC
```{r QC, echo = FALSE}

unnormalised_boxplot <- unnormalised_feature %>%
  ggplot(aes(x = originalRUN, y = log2(ABUNDANCE), col = GROUP)) +
  geom_boxplot() +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90)) +
  ggtitle("Un-normalised")
  

equalised_medians_boxplot <- equalise_medians_feature %>%
  ggplot(aes(x = originalRUN, y = log2(ABUNDANCE), col = GROUP)) +
  geom_boxplot() +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90)) +
  ggtitle("Equalise medians")
  

quantile_boxplot <- quantile_feature %>%
  ggplot(aes(x = originalRUN, y = log2(ABUNDANCE), col = GROUP)) +
  geom_boxplot() +
   theme_bw() +
  theme(axis.text.x = element_text(angle = 90)) +
  ggtitle("Quantile")


```

