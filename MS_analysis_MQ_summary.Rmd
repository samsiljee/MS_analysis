---
title: "MS_analysis_MQ_summary"
author: "Sam Siljee"
date: '2022-08-22'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Packages
```{r packages, include=FALSE}
library("tidyverse")
library("pdftools")
```

## Defining functions
```{r, include = FALSE}
# defining function to scrape table from pdf
clean_table1 <- function(raw) {
  # split the single pages
  raw <- map(raw, ~ str_split(.x, "\\n") %>% unlist())
  # concatenate the split pages
  raw <- reduce(raw, c)
  
  # specify the start and end of the table data
  table_start <- stringr::str_which(tolower(raw), "Cytoskeleton")
  table_end <- stringr::str_which(tolower(raw), "Unknown")
  table_end <- table_end[min(which(table_end > table_start))]
  
  # build the table and remove special characters
  table <- raw[(table_start):(table_end)]
  table <- str_replace_all(table, "\\s{2,}", "|")
  text_con <- textConnection(table)
  data_table <- read.csv(text_con, sep = "|")
  
  # create a list of column names
  colnames(data_table) <- c("x", "Category", "ProbeSetID", "Gene symbol", "Gene title", "Mean expression in differentiated epithelium", "Mean expression in basal cells", "Basal/differentiated epithelium expression ratio", "p value ^2")
}
```

## Importing raw data
```{r reading in MQ results from the combined folder, include=FALSE}
# importing evidence file, this is the file suggested as the main analysis file
evidence <- read_tsv("~/Coding/MS_analysis/data/combined/txt/evidence.txt") %>%
  as.data.frame()
# removing decoys
evidence <- evidence[-which(evidence$Reverse == "+"),]
# adding column with first protein name if multiple protein matches
evidence$firstProtName <- sapply(str_split(evidence$`Protein names`,";",),'[',1)
# doing the same for multiple gene name matches
evidence$firstGeneName <- sapply(str_split(evidence$`Gene names`,";",),'[',1)
# converting the "Potential contaminant" column to a vector. The "Potential contaminant" column is unhelpfully laid out, with contaminants labeled as "+". and non-contaminants labeled as NA. Hence the slightly awkward phrasing of the below code, which takes the inverse of logical return from `is.na`
evidence$potCon <- !is.na(evidence$`Potential contaminant`)

# importing all peptides
allPeptides <- read_tsv("~/Coding/MS_analysis/data/combined/txt/allPeptides.txt") %>%
  as.data.frame()

# importing phospho sites
phosphoSites <- read_tsv("~/Coding/MS_analysis/data/combined/txt/Phospho (STY)Sites.txt") %>%
  as.data.frame()
# removing decoys
phosphoSites <- phosphoSites[-which(phosphoSites$Reverse == "+"),]
# adding column with first protein name if peptide matches multiple proteins
phosphoSites$firstProtName <- sapply(str_split(phosphoSites$`Protein names`,";",),'[',1)

# extracting basal cell unique markers list from "The Human Airway Epithelial Basal Cell Transcriptome, Hacket et al. PLoS ONE, 2011)
raw_pdf <- map("~/Coding/MS_analysis/tracked_files/pone_0018378.pdf", pdf_text)
```

## Enrichment for phosphopeptides
What proportion of hits are enriched for phospho groups

```{r Phospho enrichment, echo= FALSE}
 mean(evidence$`Phospho (STY)` > 0)
```


## Contaminants

# Listing contaminants
Listing all the potential contaminants from the phospho sites data, note that at least Keratin 5 is found in basal cells, and is therefore expected

```{r looking at the identified contaminants, echo=FALSE}
#contaminants in the phosphoSites data, first creating a string of all the protein names
evidence %>%
  filter(potCon == TRUE) %>%
  .$firstProtName %>%
  unique() %>%
  sort()
```

# Looking at fraction of contaminants
Dividing the entries in contaminants marked as "potential contaminant" by total number of entries

```{r Summarising fraction of contaminants, echo = FALSE}
length(which(evidence$`Potential contaminant` == "+")) / nrow(evidence)
```

